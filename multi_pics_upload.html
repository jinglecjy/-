<!DOCTYPE html>
<html>
<head>
	<title>仿微博动态图片上传</title>
	<link href="http://cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
	<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="js/plupload/plupload.full.min.js"></script>
	<style type="text/css">
		button {
			height: 2em;
			background-color: #767997;
			border: none;
			outline: none;
			color: white;
			box-shadow: inset 2px 2px 2px #a9acca,
						inset -2px -2px 2px #434664;
		}
	</style>
</head>
<body>
	<button type="button" id="uploadBtn"><i class="fa fa-picture-o" aria-hidden="true"></i>&nbsp图片&nbsp;</button>
	<ul id="pic-list"></ul>
	<script type="text/javascript">
		var uploader = new plupload.Uploader({ // 创建实例的改造方法
			runtimes: "html5, flash, silverlight, html4", // 上传插件初始化选用方法的优先级顺序
			browse_button: "uploadBtn",                   // 上传按钮
			url: "up_pics.php?get=upimg",                 // 远程上传处理地址
			flash_swf_url: "js/plupload/Moxie.swf",       // flash文件地址
			silverlight_xap_url: "js/plupload/Moxie.xap", // silverlight文件地址
			filter: {
				max_file_size: "10mb", // 最大上传1文件大小(格式100b, 10kb, 10mb, 1gb)
				mime_types: [ // 允许文件上传的类型
					{title: "files", extensions: "jpg,png,gif"}
				]
			},
			multipart_params: {}, // 文件上传附加参数
			file_data_name: "upimg", // 文件上传名称
			multi_selection: false,  // true: 允许一次选择多个文件（ctrl）,false: 不允许
			init: {
				FileAdded: function(up, files) { // 文件上传前
					if($("#pic-list").children('li').length>9) {
						alert("已上传9张图片！");
						uploader.destroy();
					} else {
						var li = "";
						plupload.each(files, function(file) { // 遍历文件
							li += "<li id='"+file['id']+"'><div class='progress'><span class='bar'></span><span class='percent'>上传中 0%</span></div></li>";
						});
						$("#pic-list").append(li);
						uploader.start();
					}
					console.log("init");
				},
				UploadProgress: function(up, file) { // 上传中，显示进度条
					var percent = file.percent;
					$("#"+file.id).find('.bar').css({"width": percent+'%'});
					$("#"+file.id).find('.percent').text("上传中 "+percent+'%');
				},
				FileUploaded: function(up, file, info) { // 文件上传成功时触发
					var data = eval("("+info.response+")");
					$("#"+file.id).html("<img src='"+this.url+"'/><i onclick='delimg(this)'>x</i><input type='hidden' name='' value='"+this.url+"'>");
				},
				Error: function(up, err) { // 上传出错的时候触发
					alert("error");
				}
			}
		});
		uploader.init();
		function delimg(o) {
			var src = $(o).prev().attr("src");
			$.$.post('up_pics.php?get=delimg&imgurl='+src, function(data) {
				/*optional stuff to do after success */
				if(data == 1) {
					$(o).parent.remove();
				}
			});
		}
	</script>
</body>
</html>